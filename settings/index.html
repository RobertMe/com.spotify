<!doctype html>
<html>
<head>

</head>
<body>

<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
	<symbol id="user-icon" viewBox="0 0 1024 1024">
		<path
			d="m730.06 679.64q-45.377 53.444-101.84 83.443t-120 29.999q-64.032 0-120.75-30.503t-102.6-84.451q-40.335 13.109-77.645 29.747t-53.948 26.722l-17.142 10.084q-29.747 19.159-51.175 57.729t-21.428 73.107 25.461 59.242 60.754 24.705h716.95q35.293 0 60.754-24.705t25.461-59.242-21.428-72.603-51.679-57.225q-6.554-4.033-18.907-10.84t-51.427-24.453-79.409-30.755zm-221.84 25.72q-34.285 0-67.561-14.873t-60.754-40.335-51.175-60.502-40.083-75.124-25.461-84.451-9.075-87.728q0-64.032 19.915-116.22t54.452-85.964 80.67-51.931 99.072-18.151 99.072 18.151 80.67 51.931 54.452 85.964 19.915 116.22q0 65.04-20.167 130.58t-53.948 116.72-81.426 83.443-98.568 32.268z"></path>
	</symbol>
</svg>

<h1 data-i18n="settings.title"></h1>

<div id="content">
	<div id="deauthorize-container">
		<fieldset>
			<span>Logged in as:</span>
			<div id="account-container"></div>
			<button id="deauthorize" data-i18n="settings.auth.deauthorize"></button>
		</fieldset>
	</div>
	<div id="authorize-container">
		<fieldset>
			<span id="login_error"></span>
			<button id="oauth2" data-i18n="settings.auth.authorize"></button>
		</fieldset>
	</div>
</div>

<script type="text/javascript">
	window.onload = function () {
		document.getElementById('oauth2').addEventListener('click', function () {
			Homey.api('GET', '/oauth2', function (err, url) {
				if (err) {
					console.log('auth err', err);
					return document.getElementById('login_error').innerHTML = __('settings.error.invalid_credentials');
				}
				Homey.popup(url);
			});
			document.getElementById('login_error').innerHTML = '';
		});

		document.getElementById('deauthorize').addEventListener('click', function () {
			Homey.api('POST', '/deauthorize', function (err, result) {
				if (err) return Homey.alert(err.message || err.toString(), 'error');
				setAuthorizationState(false);
			})
		})
	};
</script>

<script type="text/javascript">
	function onHomeyReady() {
		Homey.get('authorized', function (err, result) {
			if (err) return setAuthorizationState(false);
			setAuthorizationState(result);
			Homey.ready();
		});

		Homey.on('authorized', function (authorized) {
			setAuthorizationState(authorized);
		});
	}

	function setAuthorizationState(authorized) {
		var deauthorizeContainer = document.getElementById('deauthorize-container');
		var authorizeContainer = document.getElementById('authorize-container');
		var accountContainer = document.getElementById('account-container');

		if (authorized) {
			authorizeContainer.style.display = 'none';
			deauthorizeContainer.style.display = 'block';
			Homey.api('GET', '/profile', function (err, profile) {
				console.log(err, profile);
				accountContainer.innerHTML =
					'<div ' + (
						profile.images.length ?
						'class="user-picture" style=\'background-image: url(\"' + profile.images[0].url + '");\'></div>' :
							'><svg class="user-icon"><use xlink:href="#user-icon"></use></svg></div>'
					) +
					'<p>' +
					'<div> <span class="label">Name:</span> ' + (profile.display_name || profile.id) + '</div>' +
					'<div> <span class="label">Email:</span> ' + profile.email + '</div>' +
					'<div> <span class="label">Subscription:</span> ' + __(profile.product) + '</div>' +
					'</p>';
			});
		} else {
			deauthorizeContainer.style.display = 'none';
			authorizeContainer.style.display = 'block';
			accountContainer.innerHTML = '';
		}
	}
</script>

<style>
	#account-container .user-picture {
		width: 64px;
		height: 64px;
		border-radius: 50%;
		display: block;
		max-width: 100%;
		vertical-align: middle;
		box-sizing: border-box;
		background-position: center center;
		background-repeat: no-repeat;
		background-size: cover;
	}

	#account-container .user-icon {
		border-radius: 50%;
		width: 64px;
		height: 64px;
		background: #393b40;
		position: relative;
		top: 4px;
	}

	#account-container .user-icon > * {
		fill: #5d5f67;
		transform: translateY(5px);
	}

	#content fieldset > * {
		clear: both;
	}

	#content fieldset > button {
		display: block;
	}

	#content fieldset > input {
		margin: 0 0 10px 15px;
		width: 250px;
	}

	#content fieldset .label,
	#content fieldset > span {
		font-weight: 400;
	}

	#content fieldset > span#current_username {
		display: block;
		padding: 0 0 10px 15px;
		font-weight: 300;
	}

	#login_error {
		color: red;
	}
</style>

</body>
</html>